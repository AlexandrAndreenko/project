---
- hosts: all
  become: yes
  vars:
    name_cms: "wordpress"
    name_db: "mariadb"
    name_docker_net: "wordpress-network" 
  roles:
    - docker  

  tasks:
    - name: Ð¡heck host
      shell: |
        hostname
        printf "\n"
        ip addr
      register: out
    - name: Show host
      debug:
        msg: "{{ out.stdout_lines }}"

    - name: Make sure firewalld is enabled
      systemd:
        name: firewalld
        state: started
        enabled: yes

    - name: Configure firewalld
      firewalld:
        zone: public
        service: "{{ item }}"
        state: enabled
        permanent: yes
        immediate: yes
      with_items:
        - http
        - https

    - name: Create a volume for db
      docker_volume:
        name: mariadb_data

    - name: Create a volume for httpd
      docker_volume:
        name: wordpress_data

    - name: Create a directory backup
      file:
        path: /data/backups
        state: directory
        owner: jenkins
        group: jenkins
        mode: 0755       

    - name: Copy docker-compose file
      template:
        src: docker-compose.yml
        dest: /var/lib/jenkins/
        owner: jenkins
        group: jenkins
        mode: 0644

    - name: Run docker-compose up
      shell: docker-compose up -d
      args:
        chdir: /var/lib/jenkins/
    

    #- name: docker run mariadb
    #  shell: |
    #    docker volume create --name mariadb_data
    #    docker run -d --name mariadb \
    #    --env ALLOW_EMPTY_PASSWORD=yes \
    #    --env MARIADB_USER=bn_wordpress \
    #    --env MARIADB_DATABASE=bitnami_wordpress \
    #    --network wordpress-network \
    #    --volume mariadb_data:/bitnami/mariadb \
    #    bitnami/mariadb:latest
    #  args:
    #    executable: /bin/bash

    #- name: docker run wordpress
    #  shell: |
    #    docker volume create --name wordpress_data
    #    docker run -d --name wordpress \
    #    -p 8080:8080 -p 8443:8443 \
    #    --env WORDPRESS_PASSWORD=QwertY_13 \
    #    --env WORDPRESS_DATABASE_USER=bn_wordpress \
    #    --env WORDPRESS_DATABASE_NAME=bitnami_wordpress \
    #    --network wordpress-network \
    #    --volume wordpress_data:/bitnami/wordpress \
    #    bitnami/wordpress:latest
    #  args:
    #    executable: /bin/bash
